<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digitales Patchday Protokoll & Assistent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons for Trash/Add -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        .step-active {
            border-left: 4px solid #2563eb;
            background-color: #eff6ff;
        }

        .step-inactive {
            border-left: 4px solid transparent;
        }

        /* Smooth transitions for row addition/removal */
        tr {
            transition: background-color 0.2s;
        }
    </style>
</head>

<body class="text-slate-800">

    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl font-bold">üõ†Ô∏è Patchday<span class="text-blue-400">Assistent</span></span>
                </div>
                <div class="text-sm opacity-80 hidden md:block">IT-Systemadministration & Lifecycle Management</div>
            </div>
        </header>

        <div class="flex-grow flex flex-col md:flex-row max-w-7xl mx-auto w-full p-4 gap-6">

            <!-- Sidebar Navigation -->
            <nav class="w-full md:w-64 flex flex-col space-y-2 flex-shrink-0">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Workflow</h3>
                    <button onclick="navTo('context')" id="nav-context"
                        class="w-full text-left px-4 py-3 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors step-active">1.
                        Mandant & Kontext</button>
                    <button onclick="navTo('backup')" id="nav-backup"
                        class="w-full text-left px-4 py-3 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors step-inactive">2.
                        QA: Backup & Prep</button>
                    <button onclick="navTo('host')" id="nav-host"
                        class="w-full text-left px-4 py-3 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors step-inactive">3.
                        Infrastruktur (Host)</button>
                    <button onclick="navTo('docker')" id="nav-docker"
                        class="w-full text-left px-4 py-3 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors step-inactive">4.
                        Container (Docker)</button>
                    <button onclick="navTo('qa')" id="nav-qa"
                        class="w-full text-left px-4 py-3 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors step-inactive">5.
                        Post-Update Tests</button>
                    <button onclick="navTo('report')" id="nav-report"
                        class="w-full text-left px-4 py-3 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors step-inactive text-blue-600">6.
                        Abschluss & Bericht</button>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 mt-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Fortschritt</h3>
                    <div class="chart-container" style="height: 150px; max-height: 150px;">
                        <canvas id="progressChart"></canvas>
                    </div>
                    <div class="text-center mt-2 text-sm font-bold text-slate-600" id="progressText">0% Abgeschlossen
                    </div>

                    <button onclick="resetData()"
                        class="mt-4 w-full text-xs text-red-500 hover:text-red-700 underline">Daten
                        zur√ºcksetzen</button>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="flex-grow space-y-6">

                <!-- Section: Context -->
                <section id="sec-context" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-slate-800">Mandanten-Kontext</h2>
                        <p class="text-slate-500 mt-1">Erfassung der Stammdaten f√ºr das Patchday-Protokoll.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Mandant / System</label>
                            <input type="text" id="input-client" placeholder="z.B. IT-Burger / RS1221+"
                                class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                oninput="updateState()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Datum</label>
                            <input type="date" id="input-date"
                                class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                oninput="updateState()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Techniker</label>
                            <input type="text" id="input-tech" placeholder="Ihr Name"
                                class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                oninput="updateState()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Ticket-Referenz</label>
                            <input type="text" id="input-ticket" placeholder="Optional: Ticket #"
                                class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                                oninput="updateState()">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button onclick="navTo('backup')"
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition font-medium">Weiter
                            zur Sicherung &rarr;</button>
                    </div>
                </section>

                <!-- Section: QA & Backup -->
                <section id="sec-backup" class="hidden bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-slate-800">1. Quality Assurance: Backup</h2>
                        <p class="text-slate-500 mt-1">Sicherung der Datenintegrit√§t.</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-600 uppercase">
                                <tr>
                                    <th class="p-3">Checkpoint</th>
                                    <th class="p-3">Methode</th>
                                    <th class="p-3">Bemerkung / Ref</th>
                                    <th class="p-3 text-center">Status</th>
                                    <th class="p-3 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="table-backup">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <button onclick="addRow('backup')"
                            class="flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium"><i
                                class="ph ph-plus-circle mr-1"></i> Zeile hinzuf√ºgen</button>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button onclick="navTo('context')"
                            class="text-slate-500 hover:text-slate-800 font-medium">&larr; Zur√ºck</button>
                        <button onclick="navTo('host')"
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition font-medium">Weiter
                            zu Infrastruktur &rarr;</button>
                    </div>
                </section>

                <!-- Section: Host Infrastructure -->
                <section id="sec-host" class="hidden bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-slate-800">2. Infrastruktur-Updates</h2>
                        <p class="text-slate-500 mt-1">Aktualisierung der Kernkomponenten.</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-600 uppercase">
                                <tr>
                                    <th class="p-3 w-1/4">Komponente</th>
                                    <th class="p-3 w-1/6">Alt-Version</th>
                                    <th class="p-3 w-1/6">Neu-Version</th>
                                    <th class="p-3">Revisionsgrund</th>
                                    <th class="p-3">Rel. Notes</th>
                                    <th class="p-3 text-center">Updated</th>
                                    <th class="p-3 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="table-host">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <button onclick="addRow('host')"
                            class="flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium"><i
                                class="ph ph-plus-circle mr-1"></i> Zeile hinzuf√ºgen</button>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button onclick="navTo('backup')" class="text-slate-500 hover:text-slate-800 font-medium">&larr;
                            Zur√ºck</button>
                        <button onclick="navTo('docker')"
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition font-medium">Weiter
                            zu Containern &rarr;</button>
                    </div>
                </section>

                <!-- Section: Docker -->
                <section id="sec-docker" class="hidden bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-slate-800">3. Containerisierte Dienste</h2>
                        <p class="text-slate-500 mt-1">Lifecycle-Management der Applikations-Images.</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-600 uppercase">
                                <tr>
                                    <th class="p-3 w-1/4">Service</th>
                                    <th class="p-3 w-1/6">Tag (Alt)</th>
                                    <th class="p-3 w-1/6">Tag (Neu)</th>
                                    <th class="p-3">Breaking Changes / Migration</th>
                                    <th class="p-3">Rel. Notes</th>
                                    <th class="p-3 text-center">Updated</th>
                                    <th class="p-3 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="table-docker">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <button onclick="addRow('docker')"
                            class="flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium"><i
                                class="ph ph-plus-circle mr-1"></i> Zeile hinzuf√ºgen</button>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button onclick="navTo('host')" class="text-slate-500 hover:text-slate-800 font-medium">&larr;
                            Zur√ºck</button>
                        <button onclick="navTo('qa')"
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition font-medium">Weiter
                            zu Tests &rarr;</button>
                    </div>
                </section>

                <!-- Section: Post-Update QA -->
                <section id="sec-qa" class="hidden bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div class="mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-slate-800">4. Post-Update Funktionstests (UAT)</h2>
                        <p class="text-slate-500 mt-1">Validierung der Funktionalit√§t.</p>
                    </div>

                    <h3 class="font-bold text-slate-700 mt-4 mb-2">4.1 Host- & Infrastruktur</h3>
                    <div class="overflow-x-auto mb-2">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-600 uppercase">
                                <tr>
                                    <th class="p-3">Dienst</th>
                                    <th class="p-3">Szenario</th>
                                    <th class="p-3">Erwartung</th>
                                    <th class="p-3 text-center">Ergebnis</th>
                                    <th class="p-3 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="table-qaHost"></tbody>
                        </table>
                    </div>
                    <div class="mb-6">
                        <button onclick="addRow('qaHost')"
                            class="flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium"><i
                                class="ph ph-plus-circle mr-1"></i> Zeile hinzuf√ºgen</button>
                    </div>

                    <h3 class="font-bold text-slate-700 mt-4 mb-2">4.2 Applikations-Ebene</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-600 uppercase">
                                <tr>
                                    <th class="p-3">App</th>
                                    <th class="p-3">Szenario</th>
                                    <th class="p-3">Erwartung</th>
                                    <th class="p-3 text-center">Ergebnis</th>
                                    <th class="p-3 w-8"></th>
                                </tr>
                            </thead>
                            <tbody id="table-qaApp"></tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <button onclick="addRow('qaApp')"
                            class="flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium"><i
                                class="ph ph-plus-circle mr-1"></i> Zeile hinzuf√ºgen</button>
                    </div>

                    <div class="mt-6 flex justify-between">
                        <button onclick="navTo('docker')" class="text-slate-500 hover:text-slate-800 font-medium">&larr;
                            Zur√ºck</button>
                        <button onclick="navTo('report')"
                            class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-medium">Bericht
                            erstellen &rarr;</button>
                    </div>
                </section>

                <!-- Section: Report & Summary -->
                <section id="sec-report" class="hidden space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <div class="mb-6 border-b pb-4 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">5. Abschluss & Dokumentation</h2>
                                <p class="text-slate-500 mt-1">Zusammenfassung des Patchdays.</p>
                            </div>
                            <button onclick="window.open('/api/report/pdf', '_blank')"
                                class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700 font-bold flex items-center gap-2"><i
                                    class="ph ph-file-pdf"></i> PDF Exportieren</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <h3 class="font-bold text-slate-700 mb-2">Aufwand-Analyse</h3>
                                <div class="chart-container">
                                    <canvas id="distributionChart"></canvas>
                                </div>
                            </div>
                            <div class="flex flex-col justify-center space-y-4">
                                <div class="bg-slate-50 p-4 rounded border border-slate-100">
                                    <div class="text-xs text-slate-400 uppercase">Gesamtstatus</div>
                                    <div class="text-2xl font-bold text-green-600" id="final-status">Erfolgreich</div>
                                </div>
                                <div class="bg-slate-50 p-4 rounded border border-slate-100">
                                    <div class="text-xs text-slate-400 uppercase">Updates durchgef√ºhrt</div>
                                    <div class="text-2xl font-bold text-slate-800" id="final-count">0</div>
                                </div>
                                <div class="bg-slate-50 p-4 rounded border border-slate-100">
                                    <div class="text-xs text-slate-400 uppercase">Gesch√§tzte Zeit</div>
                                    <div class="text-2xl font-bold text-blue-600">~ 1.5 h</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Bemerkungen & Anomalien</label>
                            <textarea id="input-remarks"
                                class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 h-24"
                                placeholder="Keine besonderen Vorkommnisse." oninput="updateState()"></textarea>
                        </div>

                        <div class="bg-slate-50 p-4 rounded border border-slate-200 font-mono text-sm overflow-x-auto">
                            <h4 class="font-bold text-slate-600 mb-2">Text-Bericht (f√ºr Ticket-System)</h4>
                            <pre id="text-report-output" class="whitespace-pre-wrap text-slate-700"></pre>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <script>
        let data = {
            metadata: { client: '', date: new Date().toISOString().split('T')[0], tech: '', ticket: '', remarks: '' },
            backup: [],
            host: [],
            docker: [],
            qaHost: [],
            qaApp: []
        };

        let progressChart = null;
        let distributionChart = null;
        let saveTimeout = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Load Data from Backend
            try {
                const res = await fetch('/api/state');
                if (res.ok) {
                    data = await res.json();
                } else {
                    console.error("Failed to load state");
                }
            } catch (e) {
                console.error("Error loading state", e);
            }

            initUI();
            initCharts();
            updateState(false); // don't save on initial load
        });

        async function saveState() {
            try {
                await fetch('/api/state', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                });
                console.log("State saved.");
            } catch (e) {
                console.error("Error saving state", e);
            }
        }

        async function resetData() {
            if (!confirm("M√∂chten Sie wirklich alle Daten zur√ºcksetzen?")) return;
            try {
                const res = await fetch('/api/state', { method: 'DELETE' });
                if (res.ok) {
                    data = await res.json();
                    initUI();
                    updateState(false);
                }
            } catch (e) {
                console.error("Error resetting", e);
            }
        }

        /* 
           Generic Render Function for all Tables
           Allows editable Name/Label/Method fields
        */
        function renderTable(key, containerId, columns) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            data[key].forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 group";

                // Helper to create Input
                const createInput = (field, placeholder, extraClass = '') => {
                    return `<input type="text" class="w-full p-1 border border-transparent hover:border-slate-300 focus:border-blue-500 rounded text-sm bg-transparent outline-none ${extraClass}" 
                        value="${item[field] || ''}" 
                        placeholder="${placeholder}"
                        oninput="data['${key}'][${idx}].${field} = this.value; updateState()">`;
                };

                let html = '';

                if (key === 'backup') {
                    html += `<td class="p-3 font-medium">${createInput('label', 'Name')}</td>`;
                    html += `<td class="p-3 text-slate-500">${createInput('method', 'Methode')}</td>`;
                    html += `<td class="p-3">${createInput('ref', 'Bemerkung')}</td>`;
                }
                else if (key === 'host' || key === 'docker') {
                    html += `<td class="p-3 font-medium">${createInput('name', 'Service Name')}</td>`;
                    html += `<td class="p-3">${createInput('old', 'Alt', 'text-xs')}</td>`;
                    html += `<td class="p-3">${createInput('new', 'Neu', 'text-xs')}</td>`;
                    html += `<td class="p-3">${createInput('reason', 'Grund', 'text-xs')}</td>`;
                    html += `<td class="p-3">${createInput('rel_notes', 'URL/Ref', 'text-xs')}</td>`;
                }
                else if (key.startsWith('qa')) {
                    html += `<td class="p-3 font-medium">${createInput('name', 'Name')}</td>`;
                    html += `<td class="p-3 text-slate-500">${createInput('scen', 'Szenario')}</td>`;
                    html += `<td class="p-3 text-slate-500 text-xs">${createInput('expect', 'Erwartung')}</td>`;
                }

                // Status Button
                let status = item.status || (item.done ? 'done' : 'pending');
                // QA overrides
                if (key.startsWith('qa')) {
                    status = item.res ? 'done' : 'pending';
                }

                let btnLabel = "Offen";
                let btnColor = "bg-slate-200 text-slate-600"; // pending

                if (status === 'wip') {
                    btnLabel = "In Arbeit";
                    btnColor = "bg-yellow-400 text-yellow-900";
                } else if (status === 'done') {
                    btnLabel = key.startsWith('qa') ? "OK" : "Erledigt";
                    btnColor = "bg-green-500 text-white";
                } else {
                    if (key.startsWith('qa')) btnLabel = "Pr√ºfen";
                }

                html += `
                    <td class="p-3 text-center">
                        <button onclick="toggleStatus('${key}', ${idx})" class="px-3 py-1 rounded text-xs font-bold ${btnColor} shadow-sm transition-all">${btnLabel}</button>
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="removeRow('${key}', ${idx})" class="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="ph ph-trash"></i></button>
                    </td>
                `;

                tr.innerHTML = html;
                container.appendChild(tr);
            });
        }

        function initUI() {
            document.getElementById('input-client').value = data.metadata.client || '';
            document.getElementById('input-date').value = data.metadata.date || '';
            document.getElementById('input-tech').value = data.metadata.tech || '';
            document.getElementById('input-ticket').value = data.metadata.ticket || '';
            document.getElementById('input-remarks').value = data.metadata.remarks || '';

            renderTables();
        }

        function renderTables() {
            renderTable('backup', 'table-backup');
            renderTable('host', 'table-host');
            renderTable('docker', 'table-docker');
            renderTable('qaHost', 'table-qaHost');
            renderTable('qaApp', 'table-qaApp');
        }

        function toggleStatus(key, idx) {
            // Cycle: pending -> wip -> done -> pending
            const current = data[key][idx].status || (data[key][idx].done ? 'done' : 'pending');
            let next = 'pending';
            if (current === 'pending') next = 'wip';
            else if (current === 'wip') next = 'done';

            data[key][idx].status = next;
            data[key][idx].done = (next === 'done'); // maintain backwards compatibility for now

            // QA Special Case (Boolean only for now or 3 states? QA is usually Pass/Fail)
            // Let's keep QA as boolean Pass/Fail for simplicity unless requested.
            // But code uses same toggleStatus. Let's differentiate.
            if (key.startsWith('qa')) {
                // QA is boolean: Offen -> OK
                data[key][idx].res = !data[key][idx].res;
                // Sync status for consistency if we wanted
            }

            updateState();
        }

        function addRow(key) {
            const empty = {
                backup: { id: Date.now(), label: 'Neu', method: '', ref: '', status: 'pending', done: false },
                host: { id: Date.now(), name: 'Neu', old: '', new: '', reason: '', rel_notes: '', status: 'pending', done: false },
                docker: { id: Date.now(), name: 'Neu', old: '', new: '', reason: '', rel_notes: '', status: 'pending', done: false },
                qaHost: { id: Date.now(), name: 'Test', scen: '', expect: '', res: false },
                qaApp: { id: Date.now(), name: 'Test', scen: '', expect: '', res: false }
            };

            // Auto-QA Creation
            if (key === 'host') {
                data['qaHost'].push({ id: Date.now() + 1, name: 'Neu (Auto)', scen: 'Funktionstest', expect: 'Dienst l√§uft', res: false });
            }
            if (key === 'docker') {
                data['qaApp'].push({ id: Date.now() + 1, name: 'Neu (Auto)', scen: 'Funktionstest', expect: 'Container l√§uft', res: false });
            }

            data[key].push(empty[key]);
            updateState();
        }

        function removeRow(key, idx) {
            if (confirm("Zeile wirklich l√∂schen?")) {
                data[key].splice(idx, 1);
                updateState();
            }
        }

        function updateState(shouldSave = true) {
            // Update Metadata
            data.metadata.client = document.getElementById('input-client').value;
            data.metadata.date = document.getElementById('input-date').value;
            data.metadata.tech = document.getElementById('input-tech').value;
            data.metadata.ticket = document.getElementById('input-ticket').value;
            data.metadata.remarks = document.getElementById('input-remarks').value;

            // Re-render to update classes or just update logic? 
            // Re-rendering clears focus, so we only re-render if structure changed (add/remove). 
            // For simple input/update, we rely on the input's own value binding. 
            // BUT: initUI calls renderTables, which builds HTML.
            // On simple text input, we DON'T want to re-render.
            // On status toggle, we might want to update button class. 
            // Let's do a targeted update for buttons if needed, but for now simple re-render of buttons is tricky without losing focus if we re-render whole table.

            // Optimization: Only re-render tables if length changes? 
            // For now, toggleStatus calls updateState. 
            // Input event calls updateState. 

            renderTables(); // This loses focus! We need to fix this.

            // FIX: Don't re-render entire table on text input.
            // But how do we distinguish? 
            // We can check document.activeElement.

            // Calculate Metrics
            const totalTasks = data.backup.length + data.host.length + data.docker.length + data.qaHost.length + data.qaApp.length;

            let completedTasks = 0;
            let wipTasks = 0;

            const check = (arr) => {
                arr.forEach(i => {
                    const s = i.status || (i.done ? 'done' : 'pending');
                    if (s === 'done') completedTasks++;
                    if (s === 'wip') wipTasks++;
                });
            };

            check(data.backup);
            check(data.host);
            check(data.docker);
            // QA
            completedTasks += data.qaHost.filter(i => i.res).length;
            completedTasks += data.qaApp.filter(i => i.res).length;

            // For chart, consider WIP as partial or separate? 
            // Doughnut: Done / WIP / Open

            const pct = totalTasks === 0 ? 0 : Math.round(((completedTasks + (wipTasks * 0.5)) / totalTasks) * 100);

            // Update Chart
            if (progressChart) {
                progressChart.data.datasets[0].data = [completedTasks, wipTasks, totalTasks - completedTasks - wipTasks];
                progressChart.data.datasets[0].backgroundColor = ['#22c55e', '#facc15', '#e2e8f0'];
                progressChart.data.labels = ['Erledigt', 'In Arbeit', 'Offen'];
                progressChart.update();
            }
            document.getElementById('progressText').innerText = `${pct}% Abgeschlossen`;

            // Update Distribution Chart in Report
            if (distributionChart) {
                // Counts per category
                const countDone = (arr) => arr.filter(i => (i.status === 'done' || i.done)).length;
                const countWip = (arr) => arr.filter(i => i.status === 'wip').length;

                distributionChart.data.datasets[0].data = [
                    countDone(data.backup),
                    countDone(data.host) + countDone(data.docker),
                    data.qaHost.filter(i => i.res).length + data.qaApp.filter(i => i.res).length
                ];
                distributionChart.update();
            }

            // Update Summary Text
            document.getElementById('final-count').innerText = completedTasks;
            generateTextReport();

            if (shouldSave) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveState, 500);
            }
        }

        // Override InitUI/Render to handle focus preservation or avoid re-render loop
        // Revised Strategy: 
        // 1. Separate "Data Update" from "View Update"
        // 2. toggleStatus shoud trigger render.
        // 3. onInput should NOT trigger render, only calculation + save.

        function renderTables() {
            // We only render if we are NOT editing text to avoid focus loss.
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;

            renderTable('backup', 'table-backup');
            renderTable('host', 'table-host');
            renderTable('docker', 'table-docker');
            renderTable('qaHost', 'table-qaHost');
            renderTable('qaApp', 'table-qaApp');
        }

        function generateTextReport() {
            const m = data.metadata;
            let text = `PATCHDAY PROTOKOLL\n`;
            text += `------------------------------------------------\n`;
            text += `Mandant:   ${m.client}\n`;
            text += `Datum:     ${m.date}\n`;
            text += `Techniker: ${m.tech}\n`;
            text += `Ticket:    ${m.ticket}\n\n`;

            text += `1. BACKUP STATUS\n`;
            data.backup.forEach(i => text += `[${i.done ? 'x' : ' '}] ${i.label} (${i.ref || 'OK'})\n`);

            text += `\n2. UPDATES (HOST & DOCKER)\n`;
            const allUpdates = [...data.host, ...data.docker];
            allUpdates.forEach(i => {
                if (i.done || i.new) {
                    text += `[${i.done ? 'x' : ' '}] ${i.name}: ${i.old || '?'} -> ${i.new || '?'}\n`;
                }
            });

            text += `\n3. FUNKTIONSTESTS (QA)\n`;
            const allQA = [...data.qaHost, ...data.qaApp];
            allQA.forEach(i => {
                text += `[${i.res ? 'OK' : 'FAIL'}] ${i.name} (${i.scen})\n`;
            });

            text += `\nBEMERKUNGEN:\n${m.remarks}\n`;
            text += `------------------------------------------------\n`;
            text += `Status: ${document.getElementById('final-status').innerText}\n`;

            document.getElementById('text-report-output').innerText = text;
        }

        function navTo(sectionId) {
            ['context', 'backup', 'host', 'docker', 'qa', 'report'].forEach(id => {
                document.getElementById(`sec-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('step-active', 'bg-blue-50', 'text-blue-700');
                document.getElementById(`nav-${id}`).classList.add('step-inactive');
            });
            document.getElementById(`sec-${sectionId}`).classList.remove('hidden');
            document.getElementById(`nav-${sectionId}`).classList.add('step-active');
            document.getElementById(`nav-${sectionId}`).classList.remove('step-inactive');
            window.scrollTo(0, 0);
        }

        function initCharts() {
            const ctxP = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: ['Erledigt', 'Offen'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#2563eb', '#e2e8f0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '75%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            const ctxD = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(ctxD, {
                type: 'bar',
                data: {
                    labels: ['Backup', 'Updates', 'QA Tests'],
                    datasets: [{
                        label: 'Erledigte Aufgaben',
                        data: [0, 0, 0],
                        backgroundColor: ['#64748b', '#3b82f6', '#22c55e'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>

</html>